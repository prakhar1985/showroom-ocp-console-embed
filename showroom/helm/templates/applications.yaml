{{- if .Values.components.showroom.enabled }}
{{- if gt (int .Values.numUsers) 0 }}
{{- /* Multi-user: create showroom-user1 through showroom-userN */}}
{{- range $i := until (int $.Values.numUsers) }}
{{- $userNum := add $i 1 }}
{{- /* Merge per-user data into shared showroom values */}}
{{- $shared := deepCopy (index $.Values.components.showroom.values "showroom") }}
{{- $perUser := dict "user" (printf "user%d" (int $userNum)) "password" ($.Values.userPassword | default "") }}
{{- $_ := set $shared "userdata" (merge $perUser (default dict $shared.userdata)) }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: showroom-user{{ $userNum }}
  namespace: {{ $.Values.argocd.namespace }}
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: {{ $.Values.argocd.project }}
  source:
    repoURL: {{ $.Values.repoUrl }}
    targetRevision: {{ $.Values.revision }}
    path: {{ $.Values.components.showroom.path }}
    helm:
      valuesObject:
        deployer:
          domain: {{ $.Values.deployer.domain | quote }}
        demo:
          namespace: {{ $.Values.demo.namespace | quote }}
          appName: {{ $.Values.demo.appName | quote }}
        showroom:
          namespace: showroom-user{{ $userNum }}
          {{- toYaml $shared | nindent 10 }}
  destination:
    server: {{ $.Values.argocd.destination.server }}
  syncPolicy:
    automated:
      selfHeal: true
      prune: true
{{- end }}
{{- else }}
{{- /* Single admin user */}}
{{- $shared := deepCopy (index .Values.components.showroom.values "showroom") }}
{{- $perUser := dict "user" "admin" "password" (.Values.userPassword | default "") }}
{{- $_ := set $shared "userdata" (merge $perUser (default dict $shared.userdata)) }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: showroom-admin
  namespace: {{ .Values.argocd.namespace }}
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: {{ .Values.argocd.project }}
  source:
    repoURL: {{ .Values.repoUrl }}
    targetRevision: {{ .Values.revision }}
    path: {{ .Values.components.showroom.path }}
    helm:
      valuesObject:
        deployer:
          domain: {{ .Values.deployer.domain | quote }}
        demo:
          namespace: {{ .Values.demo.namespace | quote }}
          appName: {{ .Values.demo.appName | quote }}
        showroom:
          namespace: showroom-admin
          {{- toYaml $shared | nindent 10 }}
  destination:
    server: {{ .Values.argocd.destination.server }}
  syncPolicy:
    automated:
      selfHeal: true
      prune: true
{{- end }}
{{- end }}
{{- if .Values.components.ocpConsoleEmbed.enabled }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: ocp-console-embed
  namespace: {{ .Values.argocd.namespace }}
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: {{ .Values.argocd.project }}
  source:
    repoURL: {{ .Values.repoUrl }}
    targetRevision: {{ .Values.revision }}
    path: {{ .Values.components.ocpConsoleEmbed.path }}
    helm:
      valuesObject:
        deployer:
          domain: {{ .Values.deployer.domain | quote }}
  destination:
    server: {{ .Values.argocd.destination.server }}
  syncPolicy:
    automated:
      selfHeal: true
      prune: true
{{- end }}
