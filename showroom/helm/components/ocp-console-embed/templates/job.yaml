# One-time Job that patches the default IngressController to strip
# iframe-blocking headers and verifies the webhook has taken effect
# on the OAuth route.
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.ocpConsoleEmbed.name }}
  namespace: {{ .Values.ocpConsoleEmbed.namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 5
  template:
    spec:
      serviceAccountName: {{ .Values.ocpConsoleEmbed.name }}
      restartPolicy: OnFailure
      containers:
        - name: setup-embed
          image: {{ .Values.ocpConsoleEmbed.image }}
          command:
            - /bin/bash
            - -ce
            - |
              DOMAIN="{{ .Values.deployer.domain }}"
              CONSOLE_HOST="console-openshift-console.${DOMAIN}"
              OAUTH_HOST="oauth-openshift.${DOMAIN}"

              echo "=== OCP Console Embed: Setup ==="
              echo "Domain: ${DOMAIN}"
              echo ""

              # -------------------------------------------------------
              # Step 1: Patch default IngressController to strip headers
              # -------------------------------------------------------
              echo "Step 1: Patching IngressController/default (delete X-Frame-Options, set CSP frame-ancestors)..."

              CSP_VALUE="frame-ancestors 'self' https://*.${DOMAIN}"

              oc patch ingresscontroller default -n openshift-ingress-operator \
                --type=merge \
                -p "{
                  \"spec\": {
                    \"httpHeaders\": {
                      \"actions\": {
                        \"response\": [
                          {
                            \"name\": \"X-Frame-Options\",
                            \"action\": { \"type\": \"Delete\" }
                          },
                          {
                            \"name\": \"Content-Security-Policy\",
                            \"action\": {
                              \"type\": \"Set\",
                              \"set\": { \"value\": \"${CSP_VALUE}\" }
                            }
                          }
                        ]
                      }
                    }
                  }
                }"
              echo "  IngressController/default patched."

              # -------------------------------------------------------
              # Step 2: Wait for webhook to convert OAuth route
              # -------------------------------------------------------
              # The mutating webhook intercepts auth operator writes and
              # converts the OAuth route from passthrough to reencrypt.
              # Wait for the operator's next reconciliation cycle (~60s).
              echo ""
              echo "Step 2: Waiting for webhook to convert OAuth route to reencrypt..."

              for i in $(seq 1 24); do
                OAUTH_TLS=$(oc get route oauth-openshift -n openshift-authentication \
                  -o jsonpath='{.spec.tls.termination}' 2>/dev/null || true)
                if [ "$OAUTH_TLS" = "reencrypt" ]; then
                  echo "  OAuth route is reencrypt (webhook working)."
                  break
                fi
                echo "  Attempt $i/24: OAuth route is '${OAUTH_TLS}', waiting 5s..."
                sleep 5
              done

              # -------------------------------------------------------
              # Step 3: Verify X-Frame-Options is gone (Console)
              # -------------------------------------------------------
              echo ""
              echo "Step 3: Verifying console X-Frame-Options is stripped..."
              echo "  Console URL: https://${CONSOLE_HOST}"

              for i in $(seq 1 30); do
                HEADERS=$(curl -skI "https://${CONSOLE_HOST}" 2>/dev/null || true)
                if echo "$HEADERS" | grep -qi "x-frame-options"; then
                  echo "  Attempt $i/30: X-Frame-Options still present, waiting 10s..."
                  sleep 10
                else
                  if echo "$HEADERS" | grep -qi "HTTP"; then
                    echo "  Console X-Frame-Options is gone."
                    break
                  else
                    echo "  Attempt $i/30: console route not responding yet, waiting 10s..."
                    sleep 10
                  fi
                fi
              done

              # -------------------------------------------------------
              # Step 4: Verify OAuth route
              # -------------------------------------------------------
              echo ""
              echo "Step 4: Checking OAuth route headers..."

              OAUTH_TLS=$(oc get route oauth-openshift -n openshift-authentication \
                -o jsonpath='{.spec.tls.termination}' 2>/dev/null || true)
              echo "  OAuth route TLS termination: ${OAUTH_TLS}"

              if [ "$OAUTH_TLS" = "reencrypt" ]; then
                for i in $(seq 1 10); do
                  HEADERS=$(curl -skI "https://${OAUTH_HOST}" 2>/dev/null || true)
                  if echo "$HEADERS" | grep -qi "x-frame-options"; then
                    echo "  Attempt $i/10: OAuth X-Frame-Options still present, waiting 5s..."
                    sleep 5
                  else
                    if echo "$HEADERS" | grep -qi "HTTP"; then
                      echo "  OAuth X-Frame-Options is gone. Login will work in iframe."
                      break
                    fi
                  fi
                done
              else
                echo "  WARNING: OAuth route is still ${OAUTH_TLS}."
                echo "  The webhook may need more time. Check webhook pod logs."
              fi

              echo ""
              echo "=== OCP Console Embed: Setup Complete ==="
