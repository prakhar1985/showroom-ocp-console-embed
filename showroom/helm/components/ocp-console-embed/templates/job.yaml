# One-time Job that patches the default IngressController to strip
# iframe-blocking headers and configures the OAuth route with reencrypt TLS.
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.ocpConsoleEmbed.name }}
  namespace: {{ .Values.ocpConsoleEmbed.namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 5
  template:
    spec:
      serviceAccountName: {{ .Values.ocpConsoleEmbed.name }}
      restartPolicy: OnFailure
      containers:
        - name: setup-embed
          image: {{ .Values.ocpConsoleEmbed.image }}
          command:
            - /bin/bash
            - -ce
            - |
              DOMAIN="{{ .Values.deployer.domain }}"
              CONSOLE_HOST="console-openshift-console.${DOMAIN}"

              echo "=== OCP Console Embed: Default IngressController Setup ==="
              echo "Domain: ${DOMAIN}"
              echo ""

              # -------------------------------------------------------
              # Step 1: Patch default IngressController to strip headers
              # -------------------------------------------------------
              echo "Step 1: Patching IngressController/default to strip X-Frame-Options and CSP..."

              oc patch ingresscontroller default -n openshift-ingress-operator \
                --type=merge \
                -p '{
                  "spec": {
                    "httpHeaders": {
                      "actions": {
                        "response": [
                          {
                            "name": "X-Frame-Options",
                            "action": { "type": "Delete" }
                          },
                          {
                            "name": "Content-Security-Policy",
                            "action": { "type": "Delete" }
                          }
                        ]
                      }
                    }
                  }
                }'
              echo "  IngressController/default patched."

              # -------------------------------------------------------
              # Step 2: Read service CA for OAuth route reencrypt TLS
              # -------------------------------------------------------
              echo ""
              echo "Step 2: Reading service CA cert..."

              SERVICE_CA=$(oc get configmap v4-0-config-system-service-ca \
                -n openshift-authentication \
                -o jsonpath='{.data.service-ca\.crt}' 2>/dev/null || true)

              if [ -z "$SERVICE_CA" ]; then
                echo "  WARNING: Could not read service CA. OAuth route patch may fail."
              else
                echo "  Service CA cert retrieved."
              fi

              # -------------------------------------------------------
              # Step 3: Patch OAuth route with reencrypt TLS
              # -------------------------------------------------------
              echo ""
              echo "Step 3: Patching Route/oauth-openshift with reencrypt TLS..."

              if [ -n "$SERVICE_CA" ]; then
                # Build the patch JSON with service CA for reencrypt
                PATCH_FILE=$(mktemp)
                python3 -c "
              import json, sys
              ca = sys.stdin.read()
              patch = {
                'spec': {
                  'tls': {
                    'termination': 'reencrypt',
                    'insecureEdgeTerminationPolicy': 'Redirect',
                    'destinationCACertificate': ca
                  }
                }
              }
              print(json.dumps(patch))
              " <<< "$SERVICE_CA" > "$PATCH_FILE"

                oc patch route oauth-openshift -n openshift-authentication \
                  --type=merge \
                  -p "$(cat "$PATCH_FILE")"
                rm -f "$PATCH_FILE"
                echo "  OAuth route patched with reencrypt TLS + service CA."
              else
                echo "  Skipping OAuth route patch (no service CA available)."
              fi

              # -------------------------------------------------------
              # Step 4: Verify X-Frame-Options is gone
              # -------------------------------------------------------
              echo ""
              echo "Step 4: Verifying X-Frame-Options is stripped..."
              echo "  Console URL: https://${CONSOLE_HOST}"

              for i in $(seq 1 30); do
                HEADERS=$(curl -skI "https://${CONSOLE_HOST}" 2>/dev/null || true)
                if echo "$HEADERS" | grep -qi "x-frame-options"; then
                  echo "  Attempt $i/30: X-Frame-Options still present, waiting 10s..."
                  sleep 10
                else
                  if echo "$HEADERS" | grep -qi "HTTP"; then
                    echo "  X-Frame-Options is gone. Console ready for iframe embedding."
                    break
                  else
                    echo "  Attempt $i/30: route not responding yet, waiting 10s..."
                    sleep 10
                  fi
                fi
              done

              echo ""
              echo "=== OCP Console Embed: Setup Complete ==="
              echo ""
              echo "Showroom ui-config.yml should use:"
              echo "  url: 'https://console-openshift-console.\${DOMAIN}'"
