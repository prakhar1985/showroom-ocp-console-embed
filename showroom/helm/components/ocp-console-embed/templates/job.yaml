# One-time Job that patches the default IngressController to strip
# iframe-blocking headers and verifies the webhook has taken effect
# on the OAuth route.
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.ocpConsoleEmbed.name }}
  namespace: {{ .Values.ocpConsoleEmbed.namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 5
  template:
    spec:
      serviceAccountName: {{ .Values.ocpConsoleEmbed.name }}
      restartPolicy: OnFailure
      containers:
        - name: setup-embed
          image: {{ .Values.ocpConsoleEmbed.image }}
          command:
            - /bin/bash
            - -ce
            - |
              DOMAIN="{{ .Values.deployer.domain }}"
              GUID="{{ .Values.deployer.guid }}"
              NUM_USERS={{ int .Values.deployer.numUsers }}
              CONSOLE_HOST="console-openshift-console.${DOMAIN}"
              OAUTH_HOST="oauth-openshift.${DOMAIN}"

              echo "=== OCP Console Embed: Setup ==="
              echo "Domain: ${DOMAIN}"
              echo "GUID: ${GUID}"
              echo "NumUsers: ${NUM_USERS}"
              echo ""

              # -------------------------------------------------------
              # Step 1: Patch default IngressController to strip headers
              # -------------------------------------------------------
              echo "Step 1: Patching IngressController/default (delete X-Frame-Options, set CSP frame-ancestors)..."

              # Build CSP with only specific Showroom route hostnames
              # instead of allowing all *.DOMAIN routes (clickjacking mitigation)
              ALLOWED_ORIGINS="'self'"
              if [ "$NUM_USERS" -gt 0 ]; then
                for i in $(seq 1 $NUM_USERS); do
                  ALLOWED_ORIGINS="${ALLOWED_ORIGINS} https://showroom-showroom-${GUID}-user${i}.${DOMAIN}"
                done
              else
                ALLOWED_ORIGINS="${ALLOWED_ORIGINS} https://showroom-showroom-${GUID}-admin.${DOMAIN}"
              fi
              CSP_VALUE="frame-ancestors ${ALLOWED_ORIGINS}"
              echo "  CSP: ${CSP_VALUE}"

              oc patch ingresscontroller default -n openshift-ingress-operator \
                --type=merge \
                -p "{
                  \"spec\": {
                    \"httpHeaders\": {
                      \"actions\": {
                        \"response\": [
                          {
                            \"name\": \"X-Frame-Options\",
                            \"action\": { \"type\": \"Delete\" }
                          },
                          {
                            \"name\": \"Content-Security-Policy\",
                            \"action\": {
                              \"type\": \"Set\",
                              \"set\": { \"value\": \"${CSP_VALUE}\" }
                            }
                          }
                        ]
                      }
                    }
                  }
                }"
              echo "  IngressController/default patched."

              # Wait for router rollout (multi-node clusters have multiple
              # router pods that need to pick up the new config)
              echo "  Waiting for router rollout to complete..."
              for i in $(seq 1 60); do
                PROGRESSING=$(oc get ingresscontroller default -n openshift-ingress-operator \
                  -o jsonpath='{.status.conditions[?(@.type=="Progressing")].status}' 2>/dev/null || true)
                if [ "$PROGRESSING" = "False" ]; then
                  echo "  Router rollout complete."
                  break
                fi
                echo "  Attempt $i/60: Router still rolling out, waiting 5s..."
                sleep 5
              done

              # -------------------------------------------------------
              # Step 2: Patch OAuth route with reencrypt TLS
              # -------------------------------------------------------
              # The Job does the initial conversion from passthrough to
              # reencrypt. The mutating webhook then maintains this state
              # against auth operator reverts long-term.
              echo ""
              echo "Step 2: Reading service CA cert..."

              SERVICE_CA=$(oc get configmap v4-0-config-system-service-ca \
                -n openshift-authentication \
                -o jsonpath='{.data.service-ca\.crt}' 2>/dev/null || true)

              if [ -z "$SERVICE_CA" ]; then
                echo "  WARNING: Could not read service CA."
              else
                echo "  Service CA cert retrieved."
              fi

              echo "  Patching Route/oauth-openshift with reencrypt TLS..."
              if [ -n "$SERVICE_CA" ]; then
                PATCH_FILE=$(mktemp)
                python3 -c "
              import json, sys
              ca = sys.stdin.read()
              patch = {
                'spec': {
                  'tls': {
                    'termination': 'reencrypt',
                    'insecureEdgeTerminationPolicy': 'Redirect',
                    'destinationCACertificate': ca
                  }
                }
              }
              print(json.dumps(patch))
              " <<< "$SERVICE_CA" > "$PATCH_FILE"

                oc patch route oauth-openshift -n openshift-authentication \
                  --type=merge \
                  -p "$(cat "$PATCH_FILE")"
                rm -f "$PATCH_FILE"
                echo "  OAuth route patched with reencrypt TLS."
              else
                echo "  Skipping OAuth route patch (no service CA)."
                echo "  The webhook will handle it when the operator reconciles."
              fi

              # -------------------------------------------------------
              # Step 3: Verify X-Frame-Options is gone (Console)
              # -------------------------------------------------------
              echo ""
              echo "Step 3: Verifying console X-Frame-Options is stripped..."
              echo "  Console URL: https://${CONSOLE_HOST}"

              for i in $(seq 1 30); do
                HEADERS=$(curl -skI "https://${CONSOLE_HOST}" 2>/dev/null || true)
                if echo "$HEADERS" | grep -qi "x-frame-options"; then
                  echo "  Attempt $i/30: X-Frame-Options still present, waiting 10s..."
                  sleep 10
                else
                  if echo "$HEADERS" | grep -qi "HTTP"; then
                    echo "  Console X-Frame-Options is gone."
                    break
                  else
                    echo "  Attempt $i/30: console route not responding yet, waiting 10s..."
                    sleep 10
                  fi
                fi
              done

              # -------------------------------------------------------
              # Step 4: Verify OAuth route
              # -------------------------------------------------------
              echo ""
              echo "Step 4: Checking OAuth route headers..."

              OAUTH_TLS=$(oc get route oauth-openshift -n openshift-authentication \
                -o jsonpath='{.spec.tls.termination}' 2>/dev/null || true)
              echo "  OAuth route TLS termination: ${OAUTH_TLS}"

              if [ "$OAUTH_TLS" = "reencrypt" ]; then
                for i in $(seq 1 10); do
                  HEADERS=$(curl -skI "https://${OAUTH_HOST}" 2>/dev/null || true)
                  if echo "$HEADERS" | grep -qi "x-frame-options"; then
                    echo "  Attempt $i/10: OAuth X-Frame-Options still present, waiting 5s..."
                    sleep 5
                  else
                    if echo "$HEADERS" | grep -qi "HTTP"; then
                      echo "  OAuth X-Frame-Options is gone. Login will work in iframe."
                      break
                    fi
                  fi
                done
              else
                echo "  WARNING: OAuth route is still ${OAUTH_TLS}."
                echo "  The webhook may need more time. Check webhook pod logs."
              fi

              echo ""
              echo "=== OCP Console Embed: Setup Complete ==="
