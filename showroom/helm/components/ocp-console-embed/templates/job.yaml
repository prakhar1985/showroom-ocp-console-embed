apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.ocpConsoleEmbed.name }}
  namespace: {{ .Values.ocpConsoleEmbed.namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: {{ .Values.ocpConsoleEmbed.name }}
      restartPolicy: OnFailure
      containers:
        - name: patch-routes
          image: {{ .Values.ocpConsoleEmbed.image }}
          command:
            - /bin/bash
            - -ce
            - |
              echo "=== OCP Console Embed: Per-Route Header Patching ==="
              echo ""

              # -------------------------------------------------------
              # Step 1: Patch openshift-console route
              # -------------------------------------------------------
              echo "Step 1: Patching Route/console in openshift-console..."
              oc patch route console -n openshift-console --type=merge -p '{
                "spec": {
                  "httpHeaders": {
                    "actions": {
                      "response": [
                        {
                          "name": "X-Frame-Options",
                          "action": {
                            "type": "Delete"
                          }
                        },
                        {
                          "name": "Content-Security-Policy",
                          "action": {
                            "type": "Delete"
                          }
                        }
                      ]
                    }
                  }
                }
              }'
              echo "  Console route patched."

              # -------------------------------------------------------
              # Step 2: Read service CA from openshift-authentication
              # -------------------------------------------------------
              echo ""
              echo "Step 2: Reading service CA cert from openshift-authentication..."
              SERVICE_CA=$(oc get configmap v4-0-config-system-service-ca \
                -n openshift-authentication \
                -o jsonpath='{.data.service-ca\.crt}' 2>/dev/null || true)

              if [ -z "$SERVICE_CA" ]; then
                echo "  WARNING: Could not read service CA. OAuth route will be patched without reencrypt TLS."
              else
                echo "  Service CA cert retrieved ($(echo "$SERVICE_CA" | wc -l | tr -d ' ') lines)."
              fi

              # -------------------------------------------------------
              # Step 3: Patch openshift-authentication oauth route
              # -------------------------------------------------------
              echo ""
              echo "Step 3: Patching Route/oauth-openshift in openshift-authentication..."

              if [ -n "$SERVICE_CA" ]; then
                # Patch with reencrypt TLS + header removal
                # Build the patch JSON with the CA cert properly escaped
                PATCH_FILE=$(mktemp)
                cat > "$PATCH_FILE" <<PATCH_EOF
              {
                "spec": {
                  "tls": {
                    "termination": "reencrypt",
                    "destinationCACertificate": $(echo "$SERVICE_CA" | python3 -c 'import sys,json; print(json.dumps(sys.stdin.read()))')
                  },
                  "httpHeaders": {
                    "actions": {
                      "response": [
                        {
                          "name": "X-Frame-Options",
                          "action": {
                            "type": "Delete"
                          }
                        },
                        {
                          "name": "Content-Security-Policy",
                          "action": {
                            "type": "Delete"
                          }
                        }
                      ]
                    }
                  }
                }
              }
              PATCH_EOF
                oc patch route oauth-openshift -n openshift-authentication \
                  --type=merge -p "$(cat "$PATCH_FILE")"
                rm -f "$PATCH_FILE"
              else
                # Patch headers only (no TLS change)
                oc patch route oauth-openshift -n openshift-authentication --type=merge -p '{
                  "spec": {
                    "httpHeaders": {
                      "actions": {
                        "response": [
                          {
                            "name": "X-Frame-Options",
                            "action": {
                              "type": "Delete"
                            }
                          },
                          {
                            "name": "Content-Security-Policy",
                            "action": {
                              "type": "Delete"
                            }
                          }
                        ]
                      }
                    }
                  }
                }'
              fi
              echo "  OAuth route patched."

              {{- if .Values.ocpConsoleEmbed.verify.enabled }}
              # -------------------------------------------------------
              # Step 4: Verify X-Frame-Options is gone from console
              # -------------------------------------------------------
              echo ""
              echo "Step 4: Verifying console no longer sends X-Frame-Options..."
              CONSOLE_URL="https://console-openshift-console.{{ .Values.deployer.domain }}"
              RETRIES={{ .Values.ocpConsoleEmbed.verify.retries }}
              INTERVAL={{ .Values.ocpConsoleEmbed.verify.interval }}

              for i in $(seq 1 $RETRIES); do
                HEADERS=$(curl -skI "$CONSOLE_URL" 2>/dev/null || true)
                if echo "$HEADERS" | grep -qi "x-frame-options"; then
                  echo "  Attempt $i/$RETRIES: X-Frame-Options still present, waiting ${INTERVAL}s..."
                  sleep $INTERVAL
                else
                  echo "  X-Frame-Options removed from console route. Embed ready."
                  echo ""
                  echo "=== OCP Console Embed: Complete ==="
                  exit 0
                fi
              done

              echo "  WARNING: X-Frame-Options still present after $RETRIES attempts."
              echo "  The route patch was applied but the router may need more time to reload."
              echo "  The console may still become embeddable shortly."
              {{- end }}

              echo ""
              echo "=== OCP Console Embed: Complete ==="
