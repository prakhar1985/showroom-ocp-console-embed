---
# One-shot Job runs immediately on deploy to patch routes
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.ocpConsoleEmbed.name }}-initial
  namespace: {{ .Values.ocpConsoleEmbed.namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: {{ .Values.ocpConsoleEmbed.name }}
      restartPolicy: OnFailure
      containers:
        - name: patch-routes
          image: {{ .Values.ocpConsoleEmbed.image }}
          command:
            - /bin/bash
            - -ce
            - |
              echo "=== OCP Console Embed: Initial Patch ==="

              # Step 1: Patch console route
              echo "Patching Route/console in openshift-console..."
              oc patch route console -n openshift-console --type=merge -p '{
                "spec": {
                  "httpHeaders": {
                    "actions": {
                      "response": [
                        {"name": "X-Frame-Options", "action": {"type": "Delete"}},
                        {"name": "Content-Security-Policy", "action": {"type": "Delete"}}
                      ]
                    }
                  }
                }
              }'

              # Step 2: Read service CA
              echo "Reading service CA cert..."
              SERVICE_CA=$(oc get configmap v4-0-config-system-service-ca \
                -n openshift-authentication \
                -o jsonpath='{.data.service-ca\.crt}' 2>/dev/null || true)

              # Step 3: Patch oauth route
              echo "Patching Route/oauth-openshift in openshift-authentication..."
              if [ -n "$SERVICE_CA" ]; then
                PATCH_FILE=$(mktemp)
                cat > "$PATCH_FILE" <<PATCH_EOF
              {
                "spec": {
                  "tls": {
                    "termination": "reencrypt",
                    "destinationCACertificate": $(echo "$SERVICE_CA" | python3 -c 'import sys,json; print(json.dumps(sys.stdin.read()))')
                  },
                  "httpHeaders": {
                    "actions": {
                      "response": [
                        {"name": "X-Frame-Options", "action": {"type": "Delete"}},
                        {"name": "Content-Security-Policy", "action": {"type": "Delete"}}
                      ]
                    }
                  }
                }
              }
              PATCH_EOF
                oc patch route oauth-openshift -n openshift-authentication \
                  --type=merge -p "$(cat "$PATCH_FILE")"
                rm -f "$PATCH_FILE"
              else
                oc patch route oauth-openshift -n openshift-authentication --type=merge -p '{
                  "spec": {
                    "httpHeaders": {
                      "actions": {
                        "response": [
                          {"name": "X-Frame-Options", "action": {"type": "Delete"}},
                          {"name": "Content-Security-Policy", "action": {"type": "Delete"}}
                        ]
                      }
                    }
                  }
                }'
              fi

              echo "=== Initial patch applied. CronJob will maintain it. ==="
---
# CronJob re-applies patches every 2 minutes to counteract operator reconciliation.
# Operators reconcile their routes and wipe spec.httpHeaders -- this puts them back.
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.ocpConsoleEmbed.name }}
  namespace: {{ .Values.ocpConsoleEmbed.namespace }}
spec:
  schedule: "{{ .Values.ocpConsoleEmbed.schedule }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      activeDeadlineSeconds: 90
      template:
        spec:
          serviceAccountName: {{ .Values.ocpConsoleEmbed.name }}
          restartPolicy: Never
          containers:
            - name: patch-routes
              image: {{ .Values.ocpConsoleEmbed.image }}
              command:
                - /bin/bash
                - -ce
                - |
                  # Check if console route already has httpHeaders patched
                  CONSOLE_HEADERS=$(oc get route console -n openshift-console \
                    -o jsonpath='{.spec.httpHeaders}' 2>/dev/null)

                  if [ -z "$CONSOLE_HEADERS" ]; then
                    echo "Console route missing httpHeaders -- re-patching..."
                    oc patch route console -n openshift-console --type=merge -p '{
                      "spec": {
                        "httpHeaders": {
                          "actions": {
                            "response": [
                              {"name": "X-Frame-Options", "action": {"type": "Delete"}},
                              {"name": "Content-Security-Policy", "action": {"type": "Delete"}}
                            ]
                          }
                        }
                      }
                    }'
                  else
                    echo "Console route httpHeaders intact."
                  fi

                  # Check oauth route
                  OAUTH_HEADERS=$(oc get route oauth-openshift -n openshift-authentication \
                    -o jsonpath='{.spec.httpHeaders}' 2>/dev/null)

                  if [ -z "$OAUTH_HEADERS" ]; then
                    echo "OAuth route missing httpHeaders -- re-patching..."
                    SERVICE_CA=$(oc get configmap v4-0-config-system-service-ca \
                      -n openshift-authentication \
                      -o jsonpath='{.data.service-ca\.crt}' 2>/dev/null || true)

                    if [ -n "$SERVICE_CA" ]; then
                      PATCH_FILE=$(mktemp)
                      cat > "$PATCH_FILE" <<PATCH_EOF
                    {
                      "spec": {
                        "tls": {
                          "termination": "reencrypt",
                          "destinationCACertificate": $(echo "$SERVICE_CA" | python3 -c 'import sys,json; print(json.dumps(sys.stdin.read()))')
                        },
                        "httpHeaders": {
                          "actions": {
                            "response": [
                              {"name": "X-Frame-Options", "action": {"type": "Delete"}},
                              {"name": "Content-Security-Policy", "action": {"type": "Delete"}}
                            ]
                          }
                        }
                      }
                    }
              PATCH_EOF
                      oc patch route oauth-openshift -n openshift-authentication \
                        --type=merge -p "$(cat "$PATCH_FILE")"
                      rm -f "$PATCH_FILE"
                    else
                      oc patch route oauth-openshift -n openshift-authentication --type=merge -p '{
                        "spec": {
                          "httpHeaders": {
                            "actions": {
                              "response": [
                                {"name": "X-Frame-Options", "action": {"type": "Delete"}},
                                {"name": "Content-Security-Policy", "action": {"type": "Delete"}}
                              ]
                            }
                          }
                        }
                      }'
                    fi
                  else
                    echo "OAuth route httpHeaders intact."
                  fi
