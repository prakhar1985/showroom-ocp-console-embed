# CronJob that periodically ensures the OAuth route stays reencrypt.
# The authentication operator reverts the route to passthrough TLS,
# which prevents HAProxy from stripping X-Frame-Options headers.
# This CronJob re-patches every 2 minutes to maintain iframe support.
# ArgoCD prune removes it on cleanup -- no residual state on pool clusters.
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.ocpConsoleEmbed.name }}-oauth-patch
  namespace: {{ .Values.ocpConsoleEmbed.namespace }}
spec:
  schedule: "*/2 * * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Replace
  jobTemplate:
    spec:
      backoffLimit: 1
      activeDeadlineSeconds: 90
      template:
        spec:
          serviceAccountName: {{ .Values.ocpConsoleEmbed.name }}
          restartPolicy: Never
          containers:
            - name: oauth-patch
              image: {{ .Values.ocpConsoleEmbed.image }}
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  cpu: 100m
                  memory: 64Mi
              command:
                - /bin/bash
                - -ce
                - |
                  DOMAIN="{{ .Values.deployer.domain }}"
                  OAUTH_HOST="oauth-openshift.${DOMAIN}"

                  # Check current TLS termination
                  CURRENT_TLS=$(oc get route oauth-openshift -n openshift-authentication \
                    -o jsonpath='{.spec.tls.termination}' 2>/dev/null || true)

                  if [ "$CURRENT_TLS" = "reencrypt" ]; then
                    # Verify headers are actually stripped
                    HEADERS=$(curl -skI "https://${OAUTH_HOST}" 2>/dev/null || true)
                    if echo "$HEADERS" | grep -qi "x-frame-options"; then
                      echo "OAuth route is reencrypt but X-Frame-Options still present. Waiting for router reload..."
                    else
                      echo "OAuth route is reencrypt and headers are stripped. Nothing to do."
                    fi
                    exit 0
                  fi

                  echo "OAuth route TLS is '${CURRENT_TLS}', patching to reencrypt..."

                  # Read service CA
                  SERVICE_CA=$(oc get configmap v4-0-config-system-service-ca \
                    -n openshift-authentication \
                    -o jsonpath='{.data.service-ca\.crt}' 2>/dev/null || true)

                  if [ -z "$SERVICE_CA" ]; then
                    echo "ERROR: Could not read service CA. Cannot patch OAuth route."
                    exit 1
                  fi

                  # Build patch and apply
                  PATCH_FILE=$(mktemp)
                  python3 -c "
                  import json, sys
                  ca = sys.stdin.read()
                  patch = {
                    'spec': {
                      'tls': {
                        'termination': 'reencrypt',
                        'insecureEdgeTerminationPolicy': 'Redirect',
                        'destinationCACertificate': ca
                      }
                    }
                  }
                  print(json.dumps(patch))
                  " <<< "$SERVICE_CA" > "$PATCH_FILE"

                  oc patch route oauth-openshift -n openshift-authentication \
                    --type=merge \
                    -p "$(cat "$PATCH_FILE")"
                  rm -f "$PATCH_FILE"

                  echo "OAuth route patched to reencrypt."
